---
# PMM Demo Workload Generator
- hosts: mysqlservers

  vars:
    percona_workload_generator_repo: 'https://github.com/michaelcoburn/pmm-demo.git'
    percona_workload_generator_directory: /opt/percona/oltp

  tasks:
    - name: Install sysbench for PMM Demo Workload generator
      yum: name=sysbench state=present
    - name: Ensure directory is present for PMM Demo Workload generator
      file: 
        path:  "{{ percona_workload_generator_directory }}"
        mode: 0755
        state: directory
    - name: Install git
      yum: name=git state=present
    - name: Checkout PMM Demo Workload generator from github.com/michaelcoburn/pmm-demo
      git:
        repo: "{{ percona_workload_generator_repo }}"
        dest: "{{ percona_workload_generator_directory }}"
        version: annotation_and_random-type_support

# Configure MySQL users required for PMM Demo Workload Generator for MySQL
# sbtest@localhost
    - mysql_user:
        name: sbtest
        password: sbtest
        host: localhost
        priv: '*.*:ALL'
        state: present
# sbtest@10.
    - mysql_user:
        name: sbtest
        password: sbtest
        host: '10.%'
        priv: '*.*:ALL'
        state: present
     
    - name: Start PMM Demo Workload generator
      shell: "{{ percona_workload_generator_directory }}/install {{ ansible_hostname }} /var/run/mysqld/mysqld.sock"
    - name: Advertise that Workload was re-generated
      shell: "pmm-admin annotate 'Deployed latest PMM Demo Workload Generator from github.com/michaelcoburn/pmm-demo' --tags 'deploy'"
